{% extends 'main/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block stylesheets %}
  <link rel="stylesheet" href="{% static 'main/css/question_details.css' %}">
  <script src="https://kit.fontawesome.com/320ceecbe5.js" crossorigin="anonymous"></script>
{% endblock stylesheets%}

{% block content %}
<div class="question_details_container">
  <div class="question">
    <div class="question_header">
      <h3 class="question_title">{{ question.title }}</h3>
      <a class="question_header__button" href="{% url 'main:create_question' %}">Ask Question</a>
    </div>
    <hr />

    <div class="question_info">
      <div class="question_votes">
        <!-- Conditionally add classes to buttons depending on current user has voted or not -->
        {% if request.user in question.questionvote.users_upvoted.all %}
          <span data-hasvoted="yes" class="vote_button user_voted" id="up">
            <i class="fas fa-caret-up"></i>
          </span>
          
        {% else %}
          <span data-hasvoted="no" class="vote_button" id="up">
            <i class="fas fa-caret-up"></i>        
          </span>
        {% endif %}
        
        <div class="question_votes__count">
          {{question.questionvote.votes}}
        </div>
        
        {% if request.user in question.questionvote.users_downvoted.all %}
          <span data-hasvoted="yes" class="vote_button user_voted" id="down">
            <i class="fas fa-caret-down" ></i>
          </span>
        {% else %}
          <span data-hasvoted="no" class="vote_button" id="down">
            <i class="fas fa-caret-down"></i>
          </span> 
        {% endif %}
        
      </div>
      <div class="question_content">
        {{ question.content | safe }}
      </div>
    </div>
    
    <div class="question_extra_info">
      <div class="question_links">
        {% if user.is_authenticated and user == question.asked_by %}
          <a class="question_links__link" href="{% url 'main:edit_question' question.id %}">Edit</a>
          <a class="question_links__link" href="{% url 'main:delete_question' question.id %}">Delete</a>
        {% endif %}
      </div>

      <div class="question_timestamp">{{ question.created_at }}</div>

      <div class="question_author">{{ question.asked_by.get_full_name }}</div>

    </div>
  </div>

  <div class="answers_container">
    {% if not answers %}
      <p>There are no answers to this question yet. </p>
    {% else %}
      {% for answer in answers %}
        <div class="answer_votes">
          <!-- Conditionally add classes to buttons depending on current user has voted or not -->
          {% if request.user in answer.answervote.users_upvoted.all %}
            <span data-hasvoted="yes" class="vote_button user_voted" id="up">
              <i class="fas fa-caret-up"></i>
            </span>
            
          {% else %}
            <span data-hasvoted="no" class="vote_button" id="up">
              <i class="fas fa-caret-up"></i>        
            </span>
          {% endif %}
          
          <div class="question_votes__count">
            {{answer.answervote.votes}}
          </div>
          
          {% if request.user in answer.answervote.users_downvoted.all %}
            <span data-hasvoted="yes" class="vote_button user_voted" id="down">
              <i class="fas fa-caret-down" ></i>
            </span>
          {% else %}
            <span data-hasvoted="no" class="vote_button" id="down">
              <i class="fas fa-caret-down"></i>
            </span> 
          {% endif %}
          
        </div>

        {{ answer.content | safe }}
        <p> {{ answer.answered_by.get_full_name }} </p>
        <small> {{answer.created_at }} </small>

        {% if user.is_authenticated and user == answer.answered_by %}
          <a href="{% url 'main:edit_answer' question.id answer.id %}">Edit</a>
          <a href="{% url 'main:delete_answer' question.id answer.id %}">Delete</a>
        {% endif %}

      {% endfor %}
    {% endif%}
  </div>

  <form action="{% url 'main:create_answer' question.id %}" method="POST">
    {% csrf_token %}

    {{ form | crispy }}

    <button class="btn btn-primary" type="submit">Submit answer</button>
  </form>
  
</div>
{% endblock content %}


{% block javascript %}
  <script>
    var csrftoken = '{{ csrf_token }}';
    var question_id = '{{ question.id }}'
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <script src="{% static 'main/js/simplemdeConfig.js' %}"></script>
  <script src="{% static 'main/js/voteQuestion.js' %}"></script>
{% endblock javascript %}